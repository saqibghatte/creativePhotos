<?php require("config.php"); if ($logged_in_admin) { if (isset($_POST["detailsOf"]) && secure($_POST["detailsOf"]) == "contact") {$recycleBin = secure($_POST["recycleBin"]);$recycleBin = ($recycleBin == "true") ? 1 : 0;$searchFName = secure($_POST['searchFName']);$searchEmail = secure($_POST['searchEmail']);$searchPhone = secure($_POST['searchPhone']);$searchMessage = secure($_POST['searchMessage']);$searchCreatedOn = secure($_POST['searchCreatedOn']);$searchModifiedOn = secure($_POST['searchModifiedOn']);$searchFName = !empty($searchFName) ? "AND fName LIKE '%$searchFName%'" : '';$searchEmail = !empty($searchEmail) ? "AND email LIKE '%$searchEmail%'" : '';$searchPhone = !empty($searchPhone) ? "AND phone LIKE '%$searchPhone%'" : '';$searchMessage = !empty($searchMessage) ? "AND message LIKE '%$searchMessage%'" : '';if (!empty($searchCreatedOn)) {$searchCreatedOn = explode('to', $searchCreatedOn);$searchCreatedOnEnd = date('Y-m-d h:i:s a', strtotime($searchCreatedOn[1]));$searchCreatedOnStart = date('Y-m-d h:i:s a', strtotime($searchCreatedOn[0]));$searchCreatedOn = "AND createdOn BETWEEN '$searchCreatedOnStart' AND '$searchCreatedOnEnd'";} else $searchCreatedOnStart = '';if (!empty($searchModifiedOn)) {$searchModifiedOn = explode('to', $searchModifiedOn);$searchModifiedOnEnd = date('Y-m-d h:i:s a', strtotime($searchModifiedOn[1]));$searchModifiedOnStart = date('Y-m-d h:i:s a', strtotime($searchModifiedOn[0]));$searchModifiedOn = "AND modifiedOn BETWEEN '$searchModifiedOnStart' AND '$searchModifiedOnEnd'";} else $searchModifiedOnStart = '';$search_params ="$searchFName $searchEmail $searchPhone $searchMessage $searchCreatedOn $searchModifiedOn";$fetchQuery = "SELECT `contact`.* FROM `contact` WHERE `contact`.`isDeleted` = $recycleBin $search_params";$data = array();$count = 0;$start = secure($_POST["start"]);$length = secure($_POST["length"]);$draw = secure($_POST["draw"]);$count_sql = "SELECT COUNT(`contact`.`id`) AS `total_count` FROM `contact` WHERE `contact`.`isDeleted` = $recycleBin $search_params";$totalCount = runQuery($count_sql)->fetch_assoc()["total_count"];$sql = "$fetchQuery ORDER BY `contact`.`id` LIMIT $start,$length";$result = runQuery($sql);while ($row = $result->fetch_object()) {$modifiers = "data-fname='$row->fName'data-email='$row->email'data-phone='$row->phone'data-message='$row->message' data-id='$row->id' ";$view='<a class="p-1 mx-1 text-success" href="contact-view?contact_id='.$row->id.'"><i class="far fa-file-alt"></i> View</a>';$delete ='<a data-toggle="modal" data-target="#deleteContact" data-id="'.$row->id.'" class="p-1 mx-1 text-danger deleteContact"><i class="fas fa-trash-alt"></i> Delete </a>';$restore='<a data-toggle="modal" data-target="#restoreContact" data-id="'.$row->id.'" class="p-1 mx-1 Contact"><i class="fas fa-trash-restore"></i> Restore </a>';if(!$recycleBin)$actions="$view$delete";else $actions="$view$restore";array_push($data, array('Full Name' => $row->fName,'Email' => $row->email,'Phone' => $row->phone,'Message' => $row->message,'Created On' => formatDateTime($row->createdOn),'Updated On' => formatDateTime($row->modifiedOn),"Sr #" => '<span class="btn-collection p-2 mt-n2">'.$actions.'</span>' . (++$count + $start),));} $results = array("draw" => $draw, "recordsTotal" => $totalCount, "recordsFiltered" => $totalCount, "aaData" => $data);echo json_encode($results);} elseif (isset($_POST["contact_id"])) {$data = array();$id = secure($_POST["contact_id"]);$contact = runQuery("SELECT `contact`.* FROM `contact` WHERE `contact`. `isDeleted` IN (0,1) AND `contact`.`id` = $id")->fetch_object();if (is_null($contact)) {echo "false";}else{$row=$contact;$modifiers = "data-fname='$row->fName'data-email='$row->email'data-phone='$row->phone'data-message='$row->message' data-id='$row->id'"; $delete="<a data-toggle='modal' data-target='#deleteContact' data-id='$contact->id' class='btn btn-danger text-white deleteContact'><i class='fas fa-trash-alt'></i> Delete </a>";$restore="<a data-toggle='modal' data-target='#restoreContact' data-id='$contact->id' class='btn btn-success text-white restoreContact'><i class='fas fa-trash-restore'></i> Restore </a>";if ($row->isDeleted == 0) $actions = "$delete"; else $actions = "$restore"; $data = array('FULL_NAME' => $row->fName,'EMAIL' => $row->email,'PHONE' => $row->phone,'MESSAGE' => $row->message,'CREATED_ON' => formatDateTime($row->createdOn),'UPDATED_ON' => formatDateTime($row->modifiedOn), "Actions" => "$actions");echo json_encode($data);}} elseif (isset($_POST["deleteContact"])) {$id = secure($_POST["contactDeleteId"]);if (is_numeric($id)) {$sql = "UPDATE `contact` SET `isDeleted` =1 WHERE `id`=$id AND `isDeleted` = 0";if (runQuery($sql)) echo "true";} else echo "false";exit();} elseif (isset($_POST["restoreContact"])) {$id = secure($_POST["contactRestoreId"]);if (is_numeric($id)) {$sql = "UPDATE `contact` SET `isDeleted` =0 WHERE `id`=$id AND `isDeleted` = 1";if (runQuery($sql)) echo "true";} else echo "false";exit();} } else echo '403 Forbidden Access';